<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Bunny Hop</title>
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#ff69b4" />
    <style>
        :root {
            --sky: #b3e5fc;
            --grass: #c8e6c9;
            --grass2: #9ccc65;
            --pink: #ff69b4;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--sky);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        main.stage {
            position: relative;
            height: 100svh;
            width: 100%;
            overflow: hidden;
            background: var(--sky);
        }

        h1 {
            position: absolute;
            top: 16px;
            left: 0;
            right: 0;
            text-align: center;
            font-family: "Comic Sans MS", "Comic Neue", cursive, system-ui;
            font-size: clamp(36px, 9vw, 72px);
            /* bigger title */
            color: var(--pink);
            text-shadow: 2px 2px 0 #fff, -2px 2px 0 #fff, 2px -2px 0 #fff, -2px -2px 0 #fff;
            letter-spacing: 2px;
            pointer-events: none;
            user-select: none;
            z-index: 1;
        }

        #grass {
            position: absolute;
            left: 50%;
            bottom: -18vh;
            transform: translateX(-50%);
            width: 150vw;
            height: 60vh;
            border-radius: 50%;
            background: radial-gradient(ellipse at center, var(--grass) 0%, var(--grass2) 85%);
            z-index: 0;
            pointer-events: none;
        }

        .bunny-wrap {
            position: absolute;
            left: 50%;
            bottom: 10vh;
            transform: translateX(-50%);
            width: min(60vmin, 340px);
            aspect-ratio: 1/1;
            overflow: hidden;
            display: grid;
            place-items: end center;
            z-index: 2;
            border-radius: 12%;
        }

        #bunny {
            position: relative;
            width: 100%;
            height: auto;
            user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            transition: transform 160ms ease;
            transform: scale(0.9);
            transform-origin: center bottom;
        }

        /* Action animations */
        .hop {
            animation: hop 350ms ease;
        }

        @keyframes hop {
            0% {
                transform: scale(1.0) translateY(0)
            }

            35% {
                transform: scale(1.0) translateY(-12vmin)
            }

            100% {
                transform: scale(1.0) translateY(0)
            }
        }

        .spin {
            animation: spin 450ms ease;
        }

        @keyframes spin {
            0% {
                transform: scale(1.0) rotate(0deg)
            }

            100% {
                transform: scale(1.0) rotate(360deg)
            }
        }

        .munch {
            animation: munch 2000ms ease;
        }

        @keyframes munch {

            0%,
            100% {
                transform: scale(1.0) translateY(0)
            }

            25% {
                transform: scale(1.0) translateY(-1vmin)
            }

            50% {
                transform: scale(1.0) translateY(0.6vmin)
            }

            75% {
                transform: scale(1.0) translateY(-0.6vmin)
            }
        }

        /* Run forward once */
        .runforward {
            animation: runforward 400ms ease forwards;
        }

        @keyframes runforward {
            0% {
                transform: scale(0.9) translateY(0);
            }

            70% {
                transform: scale(1.05) translateY(-3vh);
            }

            100% {
                transform: scale(1.0) translateY(0);
            }
        }

        /* Idle twitch */
        .twitch {
            animation: twitch 160ms ease;
        }

        @keyframes twitch {
            0% {
                transform: scale(1.0) rotate(0deg)
            }

            50% {
                transform: scale(1.0) rotate(-1.5deg)
            }

            100% {
                transform: scale(1.0) rotate(0deg)
            }
        }

        /* Carrot button */
        #btn-carrot {
            position: absolute;
            right: 16px;
            bottom: 16px;
            border: none;
            border-radius: 9999px;
            padding: 12px 14px;
            font-size: 18px;
            font-weight: 700;
            background: var(--pink);
            color: #fff;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .2);
            z-index: 3;
        }
    </style>
</head>

<body>
    <main class="stage">
        <h1 aria-hidden="true">Jolieâ€™s Phone Bunny</h1>
        <div id="grass" aria-hidden="true"></div>

        <div class="bunny-wrap">
            <img id="bunny" src="img/bunny-idle.png" alt="Bunny" />
        </div>

        <!-- Carrot button -->
        <button id="btn-carrot" aria-label="Give carrot">ðŸ¥•</button>

        <!-- Sounds -->
        <audio id="snd-hop" src="Sounds/hop.mp3" preload="auto"></audio>
        <audio id="snd-squeak" src="Sounds/squeak.mp3" preload="auto"></audio>
        <audio id="snd-crunch" src="Sounds/crunch.mp3" preload="auto"></audio>
    </main>

    <script>
        const bunny = document.getElementById('bunny');
        const sndHop = document.getElementById('snd-hop');
        const sndSqueak = document.getElementById('snd-squeak');
        const sndCrunch = document.getElementById('snd-crunch');
        const btnCarrot = document.getElementById('btn-carrot');

        function toIdle() { bunny.src = 'img/bunny-idle.png'; }

        function playWithCap(audioEl, capMs) {
            try { audioEl.currentTime = 0; } catch { }
            const p = audioEl.play();
            if (p && typeof p.catch === "function") {
                p.catch(err => console.error("Audio play failed:", audioEl.id, err));
            }
            if (capMs && Number.isFinite(capMs)) {
                setTimeout(() => {
                    audioEl.pause();
                    try { audioEl.currentTime = 0; } catch { }
                }, capMs);
            }
        }

        // One-time run forward
        let hasRunForward = false;
        function runForwardExcitedOnce() {
            if (hasRunForward) return;
            hasRunForward = true;
            bunny.classList.add('runforward');
            setTimeout(() => bunny.classList.remove('runforward'), 400);
        }

        function hop() {
            runForwardExcitedOnce();
            bunny.src = 'img/bunny-hop.png';
            playWithCap(sndHop, 500);
            bunny.classList.remove('spin', 'munch');
            bunny.classList.add('hop');
            setTimeout(() => { bunny.classList.remove('hop'); toIdle(); }, 350);
        }

        function spin() {
            runForwardExcitedOnce();
            bunny.src = 'img/bunny-spin.png';
            playWithCap(sndSqueak, 700);
            bunny.classList.remove('hop', 'munch');
            bunny.classList.add('spin');
            setTimeout(() => { bunny.classList.remove('spin'); toIdle(); }, 450);
        }

        function munch() {
            runForwardExcitedOnce();
            bunny.src = 'img/bunny-munch1.png';
            playWithCap(sndCrunch, 1200);
            bunny.classList.remove('hop', 'spin');
            bunny.classList.add('munch');
            setTimeout(() => { bunny.src = 'img/bunny-munch2.png'; }, 500);
            setTimeout(() => { bunny.classList.remove('munch'); toIdle(); }, 1200);
        }

        // Gestures
        let tapTimer = null; const DOUBLE_MS = 220;
        let pressTimer = null; const LONG_MS = 420;
        let longPressTriggered = false;

        function onPointerDown() {
            longPressTriggered = false;
            clearTimeout(pressTimer);
            pressTimer = setTimeout(() => {
                longPressTriggered = true;
                clearTimeout(tapTimer); tapTimer = null;
                munch();
            }, LONG_MS);
        }

        function onPointerUp() {
            clearTimeout(pressTimer);
            if (longPressTriggered) return;
            if (tapTimer) {
                clearTimeout(tapTimer); tapTimer = null; spin();
            } else {
                tapTimer = setTimeout(() => { hop(); tapTimer = null; }, DOUBLE_MS);
            }
        }

        bunny.addEventListener('pointerdown', onPointerDown);
        bunny.addEventListener('pointerup', onPointerUp);
        bunny.addEventListener('pointerleave', () => clearTimeout(pressTimer));
        bunny.addEventListener('pointercancel', () => clearTimeout(pressTimer));

        // Carrot button
        btnCarrot.addEventListener('click', () => {
            runForwardExcitedOnce();
            bunny.classList.add('hop'); setTimeout(() => bunny.classList.remove('hop'), 250);
            bunny.src = 'img/bunny-munch1.png';
            playWithCap(sndCrunch, 1200);
            setTimeout(() => { bunny.src = 'img/bunny-munch2.png'; }, 500);
            setTimeout(() => { toIdle(); }, 1200);
        });

        // Idle twitch
        function isAnimating() {
            return bunny.classList.contains('hop')
                || bunny.classList.contains('spin')
                || bunny.classList.contains('munch')
                || bunny.classList.contains('runforward');
        }
        function scheduleTwitch() {
            setTimeout(() => {
                if (!isAnimating()) {
                    bunny.classList.add('twitch');
                    setTimeout(() => bunny.classList.remove('twitch'), 160);
                }
                scheduleTwitch();
            }, 5000 + Math.random() * 5000);
        }
        scheduleTwitch();

        // Unlock audio once
        function unlockAudioOnce() {
            [sndHop, sndSqueak, sndCrunch].forEach(a => {
                try { a.play().then(() => a.pause()); } catch { }
            });
            window.removeEventListener('touchstart', unlockAudioOnce);
            window.removeEventListener('mousedown', unlockAudioOnce);
        }
        window.addEventListener('touchstart', unlockAudioOnce, { passive: true });
        window.addEventListener('mousedown', unlockAudioOnce);

        // Service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('SW registration failed', err));
        }
    </script>
</body>

</html>